meta {
  name: Scenario 1 POST - Get Staff
  type: http
  seq: 1
}

get {
  url: {{resourceBaseUrl}}/ed-fi/staffs/{{s1StaffId}}
  body: none
  auth: bearer
}

auth:bearer {
  token: {{certToken}}
}

script:pre-request {
  // Making the GET request to Staff and getting the ID of the staff
  await bru.sendRequest({
      url: `${bru.getEnvVar('resourceBaseUrl')}/ed-fi/staffs`,
      method: 'GET',
      headers: {
          'Authorization': 'Bearer ' + bru.getEnvVar('certToken'),
          'Accept': '*/*'
      }
  }, async function(err, res) {
      if (err) {
          console.log('Error in the Authentication Process:', err);
      } else {
          var jsonData = res.data;
          let latestBellSchedule = bru.findLatestByModifiedDate(jsonData);
  
          let latestBellScheduleDate = latestBellSchedule ? latestBellSchedule._lastModifiedDate : null;
          console.log('latestBellScheduleDate', latestBellScheduleDate);
  
          bru.setEnvVar("s1StaffId", latestBellSchedule.id);
          console.log('s1StaffId', bru.getEnvVar("s1StaffId"));
      }
  });
}

script:post-response {
  test("01 - Scenario 1 POST: Test that Staff request has 200 code status", () => {
      expect(res.getStatus()).to.equal(200);
  });
  
  let response = res.getBody();
  
  let staffUniqueIdSystemValue = bru.getEnvVar("staffUniqueIdSystemValue");
  let statementStaffUniqueId;
  
  if (staffUniqueIdSystemValue === "" || staffUniqueIdSystemValue === null) {
      statementStaffUniqueId = "207220";
  } else {
      statementStaffUniqueId = staffUniqueIdSystemValue;
  }
  
  test("02 - Scenario 1 POST: staffUniqueId value for the staff is " + statementStaffUniqueId, () => {
      expect(response.staffUniqueId, `'${statementStaffUniqueId}'  was not found in the staffUniqueId property. Retrieved value is '${response.staffUniqueId}'`).to.eql(statementStaffUniqueId);
  });
  
  test("03 - Scenario 1 POST: firstName value for the staff is 'John'", () => {
      expect(response.firstName, `'John' was not found in the staffUniqueId property. Retrieved value is '${response.firstName}'`).to.eql("John");
  });
  
  test("04 - Scenario 1 POST: hispanicLatinoEthnicity value for the staff is 'true'", () => {
      expect(response.hispanicLatinoEthnicity, `'hispanicLatinoEthnicity' is false. Retrieved value is '${response.hispanicLatinoEthnicity}'`).to.be.true;
  });
  
  test("05 - Scenario 1 POST: lastSurname value for the staff is 'Loyo'", () => {
      expect(response.lastSurname, `'Loyo' was not found in the lastSurname property . Retrieved value is '${response.lastSurname}'`).to.eql("Loyo");
  });
  
  test("06 - Scenario 1 POST: birthDate value for the staff is '1959-04-30'", () => {
      expect(response.birthDate, `'1959-04-30' was not found in the birthDate property. Retrieved value is '${response.birthDate}'`).to.eql("1959-04-30");
  });
  
  test("07 - Scenario 1 POST: generationCodeSuffix value for the staff is 'Sr'", () => {
      expect(response.generationCodeSuffix, `'Sr' was not found in the generationCodeSuffix property. Retrieved value is '${response.generationCodeSuffix}'`).to.eql("Sr");
  });
  
  test("08 - Scenario 1 POST: highestCompletedLevelOfEducationDescriptor value for the staff is 'Master's'", () => {
      expect(response.highestCompletedLevelOfEducationDescriptor, `'Master's' was not found in the highestCompletedLevelOfEducationDescriptor property. Retrieved value is '${response.highestCompletedLevelOfEducationDescriptor}'`).to.contain("Master's");
  });
  
  test("09 - Scenario 1 POST: highlyQualifiedTeacher value for the staff is 'true'", () => {
      expect(response.highlyQualifiedTeacher, `'highlyQualifiedTeacher' is false. Retrieved value is '${response.hispanicLatinoEthnicity}'`).to.be.true;
  });
  
  test("10 - Scenario 1 POST: sexDescriptor value for the staff is 'Male'", () => {
      expect(response.sexDescriptor, `'Male' was not found in the sexDescriptor property. Retrieved value is '${response.sexDescriptor}'`).to.contain("Male");
  });
  
  let expectedElectronicMailAddress = "johnloyo@edficert.org";
  let expectedElectronicMailTypeDescriptor = "Work";
  let electronicMailsArray = response.electronicMails;
  expect(electronicMailsArray).to.be.an("array");
  
  test("11 - Scenario 1 POST: electronicMailAddress value for the staff is " + expectedElectronicMailAddress, ()=> {
      let foundValidStaffElectronicMailAddress = false;
      for (let i = 0; i < electronicMailsArray.length; i++) {
          let electronicMailItem = electronicMailsArray[i];
          let electronicMailAddress = electronicMailItem.electronicMailAddress;
          if (electronicMailAddress === expectedElectronicMailAddress) {
              foundValidStaffElectronicMailAddress = true;
              break;
          }
      }
      expect(foundValidStaffElectronicMailAddress, `'${expectedElectronicMailAddress}' was not found in any of the electronicMailAddress properties. Retrieved value(s) '${JSON.stringify(electronicMailsArray.map(item => item.electronicMailAddress))}'. Please take a look at the response for more information.`).to.be.true;
  });
  
  test("12 - Scenario 1 POST: electronicMailTypeDescriptor value for the staff is " + expectedElectronicMailTypeDescriptor, () => {
      let foundValidStaffElectronicMailTypeDescriptor = false;
      for (let i = 0; i < electronicMailsArray.length; i++) {
          let electronicMailItem = electronicMailsArray[i];
          let electronicMailTypeDescriptor = electronicMailItem.electronicMailTypeDescriptor;
          let electronicMailAddress = electronicMailItem.electronicMailAddress;
          if (electronicMailAddress === expectedElectronicMailAddress && electronicMailTypeDescriptor.includes(expectedElectronicMailTypeDescriptor)) {
              foundValidStaffElectronicMailTypeDescriptor = true;
              break;
          }
      }
      expect(foundValidStaffElectronicMailTypeDescriptor, `'${expectedElectronicMailTypeDescriptor}' was not found with '${expectedElectronicMailAddress}'. But found '${JSON.stringify(electronicMailsArray)}'. Please take a look at the response for more information`).to.be.true;
  });
  
  
}

settings {
  encodeUrl: true
}
