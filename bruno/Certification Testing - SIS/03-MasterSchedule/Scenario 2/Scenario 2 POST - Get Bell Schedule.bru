meta {
  name: Scenario 2 POST - Get Bell Schedule
  type: http
  seq: 1
}

get {
  url: {{resourceBaseUrl}}/ed-fi/bellSchedules/{{s2BellScheduleId}}
  body: none
  auth: bearer
}

auth:bearer {
  token: {{certToken}}
}

script:pre-request {
  // Making the GET request to Bell Schedule and getting the ID of the bell schedule
  await bru.sendRequest({
      url: `${bru.getEnvVar('resourceBaseUrl')}/ed-fi/bellSchedules`,
      method: 'GET',
      headers: {
          'Authorization': 'Bearer ' + bru.getEnvVar('certToken'),
          'Accept': '*/*'
      }
  }, async function(err, res) {
      if (err) {
          console.log('Error in the Authentication Process:', err);
      } else {
          var jsonData = res.data;

          // Find the latest item by _lastModifiedDate using native JavaScript
          let latestBellSchedule = jsonData.reduce((latest, current) => {
              return (!latest || current._lastModifiedDate > latest._lastModifiedDate) ? current : latest;
          }, null);
  
          let latestBellScheduleDate = latestBellSchedule ? latestBellSchedule._lastModifiedDate : null;
          console.log('latestBellScheduleDate', latestBellScheduleDate);
  
          bru.setEnvVar("s2BellScheduleId", latestBellSchedule.id);
          console.log('s2BellScheduleId', bru.getEnvVar("s2BellScheduleId"));
      }
  });
}

script:post-response {
  test("01 - Scenario 2 POST: Test that Bell Schedule request has 200 code status", () => {
      expect(res.getStatus()).to.equal(200);
  });
  
  let response = res.getBody();
  
  test("02 - Scenario 2 POST: bellScheduleName value for the bell schedule is 'Normal Schedule B'", () => {
      expect(response.bellScheduleName, `'Normal Schedule B' was not found in the bellScheduleName property. Retrieved value is '${response.bellScheduleName}'`).to.eql("Normal Schedule B");
  });
  
  test("03 - Scenario 2 POST: schoolId value for the bell schedule is '255901107'", () =>{
      expect(response.schoolReference.schoolId, `'255901107' was not found in the schoolId property. Retrieved value is '${response.schoolReference.schoolId}'`).to.eql(255901107);
  });
  
  expect(response.classPeriods).to.be.an("array");
  let classPeriodsArray = response.classPeriods;
  console.log("classPeriodsArray",classPeriodsArray)
  
  test("04 - Scenario 2 POST: classPeriodName value for the bell schedule is 'Class Period 4'", () => {
      let classPeriod4 = classPeriodsArray.some(item =>  item.classPeriodReference.classPeriodName.includes("Class Period 4"));
  
      console.log("classPeriod4", classPeriod4);
  
      expect(classPeriod4, `'Class Period 4' was not found in any of the class period references. Please take a look at the response. For additional information take a look at the console.'`).to.be.true;
  });
  
  test("05 - Scenario 2 POST: classPeriodName value for the bell schedule is 'Class Period 5'", () => {
      let classPeriod5 = classPeriodsArray.some(item =>  item.classPeriodReference.classPeriodName.includes("Class Period 5"));
  
      console.log("classPeriod5", classPeriod5);
  
      expect(classPeriod5, `'Class Period 5' was not found in any of the class period references. Please take a look at the response. For additional information take a look at the console.'`).to.be.true;
  });
  
  test("06 - Scenario 2 POST: classPeriodName value for the bell schedule is 'Class Period 6'", () => {
      let classPeriod6 = classPeriodsArray.some(item =>  item.classPeriodReference.classPeriodName.includes("Class Period 6"));
  
      console.log("classPeriod6", classPeriod6);
  
      expect(classPeriod6, `'Class Period 6' was not found in any of the class period references. Please take a look at the response. For additional information take a look at the console.'`).to.be.true;
  });
  
  test("07 - Scenario 2 POST: alternateDayName value for the bell schedule is 'B'", () => {
      expect(response.alternateDayName, `'B' was not found in the alternateDayName property. Retrieved value is '${response.alternateDayName}'`).to.eql("B");
  });
  
}

settings {
  encodeUrl: true
}
