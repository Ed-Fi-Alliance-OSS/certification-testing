meta {
  name: Scenario 2 POST - Get Student School Association
  type: http
  seq: 2
}

get {
  url: {{resourceBaseUrl}}/ed-fi/studentSchoolAssociations/{{s2StudentSchoolAssociationId}}
  body: none
  auth: bearer
}

auth:bearer {
  token: {{certToken}}
}

script:pre-request {
  // Making the GET request to Student School Association and getting the ID of the student school association
  await bru.sendRequest({
      url: `${bru.getEnvVar('resourceBaseUrl')}/ed-fi/studentSchoolAssociations`,
      method: 'GET',
      headers: {
          'Authorization': 'Bearer ' + bru.getEnvVar('certToken'),
          'Accept': '*/*'
      }
  }, async function(err, res) {
      if (err) {
          console.log('Error in the Authentication Process:', err);
      } else {
          var jsonData = res.data;

          // Find the latest item by _lastModifiedDate using native JavaScript
          let latestStudentSchoolAssociation = jsonData.reduce((latest, current) => {
              return (!latest || current._lastModifiedDate > latest._lastModifiedDate) ? current : latest;
          }, null);
  
          let latestStudentSchoolAssociationDate = latestStudentSchoolAssociation ? latestStudentSchoolAssociation._lastModifiedDate : null;
          console.log('latestStudentSchoolAssociationDate', latestStudentSchoolAssociationDate);
  
          bru.setEnvVar("s2StudentSchoolAssociationId", latestStudentSchoolAssociation.id);
          console.log('s2StudentSchoolAssociationId', bru.getEnvVar("s2StudentSchoolAssociationId"));
      }
  });
}

script:post-response {
  test("02 - Scenario 2 POST: Test that Student School Association request has 200 code status", () => {
      expect(res.getStatus()).to.equal(200);
  });
  
  let response = res.getBody();
  
  let dateObject = new Date();
  let currentYear = dateObject.getFullYear();
  
  let expectedSchoolId = 255901001;
  let expectedStudentUniqueId = "222222";
  let expectedEntryDate = `${currentYear}-08-31`;
  let expectedEntryGradeLevelDescriptor = "Ninth grade";
  let expectedEntryTypeDescriptor = "Next year school";
  let expectedRepeatGradeIndicator = false;
  let expectedResidencyStatusDescriptor = "Resident of admin unit and school area";
  let expectedSchoolChoiceTransfer = false;
  
  test("02 - Scenario 2 POST: schoolId value for the Student School Association is " + expectedSchoolId, () => {
      expect(response.schoolReference.schoolId, `'${expectedSchoolId}' was not found in the schoolId from the schoolReference for the Student School Association. Retrieved value is '${response.schoolReference.schoolId}'`).to.eql(expectedSchoolId);
  });
  
  test("03 - Scenario 2 POST: studentUniqueId value for the Student School Association is " + expectedStudentUniqueId, () => {
      expect(response.studentReference.studentUniqueId, `'${expectedStudentUniqueId}' was not found in the studentUniqueId from the studentReference for the Student School Association. Retrieved value is '${response.studentReference.studentUniqueId}'`).to.eql(expectedStudentUniqueId);
  });
  
  test("04 - Scenario 2 POST: entryDate value for the Student School Association is " + expectedEntryDate, () => {
      expect(response.entryDate, `'${expectedEntryDate}' was not found in the entryDate property for the Student School Association. Retrieved value is '${response.entryDate}'`).to.eql(expectedEntryDate);
  });
  
  test("05 - Scenario 2 POST: entryGradeLevelDescriptor value for the Student School Association is " + expectedEntryGradeLevelDescriptor, () => {
      expect(response.entryGradeLevelDescriptor, `'${expectedEntryGradeLevelDescriptor}' was not found in the entryGradeLevelDescriptor property for the Student School Association. Retrieved value is '${response.entryGradeLevelDescriptor}'`).to.contain(expectedEntryGradeLevelDescriptor);
  });
  
  test("06 - Scenario 2 POST: entryTypeDescriptor value for the Student School Association is " + expectedEntryTypeDescriptor, () => {
      expect(response.entryTypeDescriptor, `'${expectedEntryTypeDescriptor}' was not found in the expectedEntryTypeDescriptor property for the Student School Association. Retrieved value is '${response.entryTypeDescriptor}'`).to.contain(expectedEntryTypeDescriptor);
  });
  
  test("07 - Scenario 2 POST: repeatGradeIndicator value for the Student School Association is " + expectedRepeatGradeIndicator, () => {
      expect(response.repeatGradeIndicator, `'${expectedRepeatGradeIndicator}' was not found in the repeatGradeIndicator property for the Student School Association. Retrieved value is '${response.repeatGradeIndicator}'`).to.be.false;
  });
  
  test("08 - Scenario 2 POST: residencyStatusDescriptor value for the Student School Association is " + expectedResidencyStatusDescriptor, () => {
      expect(response.residencyStatusDescriptor, `'${expectedResidencyStatusDescriptor}' was not found in the residencyStatusDescriptor property for the Student School Association. Retrieved value is '${response.residencyStatusDescriptor}'`).to.contain(expectedResidencyStatusDescriptor);
  });
  
  test("09 - Scenario 2 POST: schoolChoiceTransfer value for the Student School Association is " + expectedSchoolChoiceTransfer, () => {
      expect(response.schoolChoiceTransfer, `'${expectedSchoolChoiceTransfer}' was not found in the schoolChoiceTransfer property for the Student School Association. Retrieved value is '${response.schoolChoiceTransfer}'`).to.be.false;
  });
}

settings {
  encodeUrl: true
}
